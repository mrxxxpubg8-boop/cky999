<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>SZ28 @SZ28BOT</title>
<style>
body { font-family: Arial, sans-serif; text-align:center; background:#f8f8f8; margin:0; padding:0; }
h1 { margin-top:20px; font-size:28px; font-weight:bold; }
button { padding:5px 10px; margin:0 5px; cursor:pointer; font-size:16px; }

#passwordOverlay {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content:center;
    align-items:center;
    z-index: 1000;
}

#passwordBox {
    background:#fff;
    padding:20px 30px;
    border-radius:12px;
    text-align:center;
}

#controls {
    display:flex;
    justify-content:center;
    align-items:center;
    margin-bottom:20px;
    gap:10px;
}

#infoBoxes {
    display:flex; 
    justify-content:center; 
    gap:20px; 
    margin-bottom:20px;
}

.infoBox {
    background:#e0f0ff; 
    padding:10px 20px; 
    border-radius:10px; 
    font-size:20px; 
    font-weight:bold;
}

table { border-collapse: collapse; margin:auto; width:90%; background:#fff; }
th, td { border:1px solid #ccc; padding:5px; text-align:center; font-weight:bold; }
th { background:#eee; }
.correct { color: green; }
.wrong { color: red; }

#nextPred, #winRate { font-size:20px; font-weight:bold; margin:10px auto; }

footer { 
    margin-top:30px; 
    font-size:42px;  
    font-weight:bold; 
    color:#fff;
    background: linear-gradient(to right, #1e3c72, #2a5298); 
    padding:15px 0;
    border-radius:12px;
}
</style>
</head>
<body>
<h1>SZ28 @SZ28BOT</h1>

<!-- 密码输入遮罩 -->
<div id="passwordOverlay">
    <div id="passwordBox">
        <p>请输入访问密码：</p>
        <input type="password" id="passwordInput" placeholder="Password"/>
        <button onclick="checkPassword()">提交</button>
        <p id="passwordMsg" style="color:red; margin-top:10px;"></p>
    </div>
</div>

<!-- 控制按钮 -->
<div id="controls">
    <button onclick="switchAlgorithm(1)">算法1</button>
    <button onclick="switchAlgorithm(2)">算法2</button>
    <button onclick="loadData()">刷新数据</button>
</div>

<div id="infoBoxes">
    <div class="infoBox"><span id="nextPred">加载中...</span></div>
    <div class="infoBox"><span id="winRate">加载中...</span></div>
</div>

<h2>最近 20 期预测结果</h2>
<table id="historyTable">
<tr><th>期号</th><th>预测</th><th>开奖和值</th><th>结果</th></tr>
</table>

<footer>BY CKY</footer>

<script>
let currentAlgorithm = 1;
const validPasswords = ["sz28test1","sz28test2","sz28test3","sz28test4","sz28test5"];

// 密码检查
function checkPassword(){
    const pw = document.getElementById('passwordInput').value.trim();
    if(validPasswords.includes(pw)){
        localStorage.setItem("sz28_pass", pw);
        document.getElementById('passwordOverlay').style.display="none";
        loadData();
    }else{
        document.getElementById('passwordMsg').innerText="密码错误，请重试！";
    }
}

// 页面加载检查密码
window.onload = function(){
    const saved = localStorage.getItem("sz28_pass");
    if(saved && validPasswords.includes(saved)){
        document.getElementById('passwordOverlay').style.display="none";
        loadData();
    }
};

// 切换算法
function switchAlgorithm(n){
    currentAlgorithm = n;
    loadData();
}

// ----------------- 预测算法 -----------------
function sum(arr){ return arr.reduce((a,b)=>a+b,0); }

// 算法1（原老算法）
function calcPrediction1(last3_nums){
    if(last3_nums.length<3) return null;
    let a = (sum(last3_nums[2])+last3_nums[2][0])/0.28 +
            (sum(last3_nums[1])+last3_nums[1][0])/0.28 +
            (sum(last3_nums[0])+last3_nums[0][0])/0.28;
    let b = Math.sqrt(a);
    let c = b / 3;
    let decimal = c.toFixed(3).split('.')[1];
    let digitSum = decimal.split('').reduce((s,d)=>s+parseInt(d),0);
    if(digitSum < 14){
        return digitSum%2===0 ? '杀大双':'杀大单';
    } else {
        return digitSum%2===0 ? '杀小双':'杀小单';
    }
}

// 算法2（shazu_two.py逻辑）
function calcPrediction2(last3_nums){
    if(last3_nums.length<3) return null;
    let a = (sum(last3_nums[2])+last3_nums[2][0])/4 +
            (sum(last3_nums[1])+last3_nums[1][0])/4 +
            (sum(last3_nums[0])+last3_nums[0][0])/4;
    let b = Math.sqrt(a);
    let c = b / 28;
    let decimal = c.toFixed(3).split('.')[1];
    let digitSum = decimal.split('').reduce((s,d)=>s+parseInt(d),0);
    if(digitSum < 14){
        return digitSum%2===0 ? '杀小双':'杀小单';
    } else {
        return digitSum%2===0 ? '杀大双':'杀大单';
    }
}

// 胜负判断
function checkWin(pred, total){
    let size = total>=14?'大':'小';
    let parity = total%2===1?'单':'双';
    let combination = size+parity;
    if(pred==='杀小单' && combination!=='小单') return '✅';
    if(pred==='杀小双' && combination!=='小双') return '✅';
    if(pred==='杀大单' && combination!=='大单') return '✅';
    if(pred==='杀大双' && combination!=='大双') return '✅';
    return '❌';
}

// 获取JSON
async function fetchJSON(url){
    try{
        const resp = await fetch(url);
        return await resp.json();
    } catch(e){ console.error(e); return null; }
}

// 数据加载
async function loadData(){
    const latestData = await fetchJSON('https://pc28.help/kj.json');
    if(!latestData || !latestData.data){ alert("获取数据失败"); return; }
    const latestQihao = parseInt(latestData.data[0].qihao);
    const recordDict = {};
    for(let q=latestQihao-22;q<=latestQihao;q++){
        const rec = await fetchJSON(`https://pc28.help/qihao/${q}`);
        if(rec && rec.data){
            const nums = rec.data[0].opennum.replace(/,/g,'+').split('+').map(Number).slice(0,3);
            if(nums.length>=3) recordDict[q] = nums;
        }
    }

    const sortedQihao = Object.keys(recordDict).map(Number).sort((a,b)=>b-a); // 新->旧
    const historyTable = document.getElementById('historyTable');
    historyTable.innerHTML='<tr><th>期号</th><th>预测</th><th>开奖和值</th><th>结果</th></tr>';

    let winCount = 0;
    const testQihaoList = sortedQihao.slice(0,20);

    for(let curQihao of testQihaoList){
        const prevQihaos = sortedQihao.filter(q=>q<curQihao).sort((a,b)=>b-a);
        if(prevQihaos.length<3) continue;
        const last3_nums = prevQihaos.slice(0,3).map(q=>recordDict[q]);
        let pred = currentAlgorithm===1 ? calcPrediction1(last3_nums) : calcPrediction2(last3_nums);
        let total = sum(recordDict[curQihao]);
        if(total<10) total = '0'+total;
        const res = checkWin(pred,sum(recordDict[curQihao]));
        if(res==='✅') winCount++;
        const tr = document.createElement('tr');
        tr.innerHTML=`<td>${curQihao}</td><td>${pred}</td><td>${total}</td><td class="${res==='✅'?'correct':'wrong'}">${res}</td>`;
        historyTable.appendChild(tr);
    }

    const winRate = (winCount/testQihaoList.length*100).toFixed(1);
    document.getElementById('winRate').innerText=`历史胜率: ${winRate}%`;

    const latestThree = sortedQihao.slice(0,3).map(q=>recordDict[q]);
    let nextPred = currentAlgorithm===1 ? calcPrediction1(latestThree) : calcPrediction2(latestThree);
    document.getElementById('nextPred').innerText=`最新${latestQihao+1}期预测: ${nextPred}`;
}
</script>
</body>
</html>
