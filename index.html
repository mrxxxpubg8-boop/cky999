<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>SZ28 @SZ28BOT</title>
<style>
body { font-family: Arial, sans-serif; text-align:center; background:#f8f8f8; margin:0; padding:0; }
h1 { margin-top:20px; font-size:28px; font-weight:bold; }
button { padding:5px 10px; cursor:pointer; font-size:16px; }

#passwordOverlay {
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:#f8f8f8; display:flex; justify-content:center; align-items:center;
    flex-direction:column; z-index:9999;
}
#passwordOverlay input { padding:10px; font-size:18px; }
#passwordOverlay button { margin-top:10px; padding:8px 16px; font-size:16px; }
#passwordError { color:red; margin-top:10px; }

#controls {
    display:flex; justify-content:center; gap:10px; align-items:center; margin-bottom:20px;
}
#algorithmSelect { font-size:16px; padding:5px; }

#infoBoxes {
    display:flex; justify-content:center; gap:20px; margin-bottom:20px;
}
.infoBox {
    background:#e0f0ff; padding:10px 20px; border-radius:10px; font-size:20px; font-weight:bold;
    display:flex; align-items:center; gap:5px;
}

table { border-collapse: collapse; margin:auto; width:90%; background:#fff; }
th, td { border:1px solid #ccc; padding:5px; text-align:center; font-weight:bold; }
th { background:#eee; }
.correct { color: green; }
.wrong { color: red; }

footer { 
    margin-top:15px; font-size:42px; font-weight:bold; color:#fff;
    background: linear-gradient(to right, #1e3c72, #2a5298); padding:12px 0; border-radius:12px;
}
#version { font-size:20px; font-weight:bold; margin-top:5px; }
</style>
</head>
<body>

<!-- å¯†ç è¦†ç›–å±‚ -->
<div id="passwordOverlay">
    <h2>è¯·è¾“å…¥è®¿é—®å¯†ç </h2>
    <input type="password" id="passwordInput" placeholder="å¯†ç ">
    <button onclick="checkPassword()">æäº¤</button>
    <p id="passwordError"></p>
</div>

<!-- ä¸»å†…å®¹ -->
<div id="mainContent" style="display:none;">
    <h1>SZ28 @SZ28BOT</h1>
    <div id="controls">
        <select id="algorithmSelect" onchange="loadData()">
            <option value="1">ç®—æ³•1</option>
            <option value="2">ç®—æ³•2</option>
        </select>
        <button onclick="loadData()">åˆ·æ–°æ•°æ®</button>
    </div>

    <div id="infoBoxes">
        <div class="infoBox" id="nextPredBox"><span id="nextPred">åŠ è½½ä¸­...</span></div>
        <div class="infoBox" id="winRateBox"><span id="winRate">åŠ è½½ä¸­...</span></div>
    </div>

    <h2>æœ€è¿‘ 20 æœŸé¢„æµ‹ç»“æœ</h2>
    <table id="historyTable">
        <tr><th>æœŸå·</th><th>é¢„æµ‹</th><th>å¼€å¥–å’Œå€¼</th><th>ç»“æœ</th></tr>
    </table>

    <footer>
        BY CKY
        <div id="version">æ€ç»„28 ç‰ˆæœ¬ v1.0.8</div>
    </footer>
<script>
// ==== å¯†ç éªŒè¯ ====
const passwordList = ["sz28test1","sz28test2","sz28test3","sz28test4","sz28test5"];
function checkPassword() {
    const pw = document.getElementById("passwordInput").value;
    if(passwordList.includes(pw)){
        document.getElementById("passwordOverlay").style.display="none";
        document.getElementById("mainContent").style.display="block";
        loadData();
    } else {
        document.getElementById("passwordError").innerText="å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•";
    }
}

// ==== å·¥å…·å‡½æ•° ====
function sum(arr){ return arr.reduce((a,b)=>a+b,0); }
function checkWin(pred, total){
    let size = total>=14?'å¤§':'å°';
    let parity = total%2===1?'å•':'åŒ';
    let combination = size+parity;
    if(pred==='æ€å°å•' && combination!=='å°å•') return 'âœ…';
    if(pred==='æ€å°åŒ' && combination!=='å°åŒ') return 'âœ…';
    if(pred==='æ€å¤§å•' && combination!=='å¤§å•') return 'âœ…';
    if(pred==='æ€å¤§åŒ' && combination!=='å¤§åŒ') return 'âœ…';
    return 'âŒ';
}

// ç®—æ³•1
function calcAlgorithm1(last3_nums){
    let a = (sum(last3_nums[2])+last3_nums[2][0])/0.28 +
            (sum(last3_nums[1])+last3_nums[1][0])/0.28 +
            (sum(last3_nums[0])+last3_nums[0][0])/0.28;
    let b = Math.sqrt(a);
    let c = b / 3;
    let decimal = c.toFixed(3).split('.')[1];
    let digitSum = decimal.split('').reduce((s,d)=>s+parseInt(d),0);
    if(digitSum < 14){
        return digitSum%2===0 ? 'æ€å¤§åŒ':'æ€å¤§å•';
    } else {
        return digitSum%2===0 ? 'æ€å°åŒ':'æ€å°å•';
    }
}

// ç®—æ³•2
function calcAlgorithm2(last3_nums){
    let a = (sum(last3_nums[2])+last3_nums[2][0])/4 +
            (sum(last3_nums[1])+last3_nums[1][0])/4 +
            (sum(last3_nums[0])+last3_nums[0][0])/4;
    let b = Math.sqrt(a);
    let c = b / 28;
    let decimal = c.toFixed(3).split('.')[1];
    let digitSum = decimal.split('').reduce((s,d)=>s+parseInt(d),0);
    if(digitSum < 14){
        return digitSum%2===0 ? 'æ€å°åŒ':'æ€å°å•';
    } else {
        return digitSum%2===0 ? 'æ€å¤§åŒ':'æ€å¤§å•';
    }
}

// ==== è·å– JSON ====
async function fetchJSON(url){
    try{
        const resp = await fetch(url);
        return await resp.json();
    } catch(e){ console.error(e); return null; }
}

// ==== åŠ è½½æ•°æ® ====
async function loadData(){
    const latestData = await fetchJSON('https://pc28.help/kj.json');
    if(!latestData || !latestData.data){
        alert("è·å–æ•°æ®å¤±è´¥");
        return;
    }
    const latestQihao = parseInt(latestData.data[0].qihao);
    const recordDict = {};
    for(let q=latestQihao-22;q<=latestQihao;q++){
        const rec = await fetchJSON(`https://pc28.help/qihao/${q}`);
        if(rec && rec.data){
            const nums = rec.data[0].opennum.replace(/,/g,'+').split('+').map(Number).slice(0,3);
            if(nums.length>=3) recordDict[q] = nums;
        }
    }

    const sortedQihao = Object.keys(recordDict).map(Number).sort((a,b)=>b-a);
    const historyTable = document.getElementById('historyTable');
    historyTable.innerHTML='<tr><th>æœŸå·</th><th>é¢„æµ‹</th><th>å¼€å¥–å’Œå€¼</th><th>ç»“æœ</th></tr>';

    const selectedAlgo = document.getElementById("algorithmSelect").value;
    const testQihaoList = sortedQihao.slice(0,20);
    let winCount = 0;

    for(let curQihao of testQihaoList){
        const prevQihaos = sortedQihao.filter(q=>q<curQihao).sort((a,b)=>b-a);
        if(prevQihaos.length<3) continue;
        const last3_nums = prevQihaos.slice(0,3).map(q=>recordDict[q]);
        let pred = selectedAlgo==='1'?calcAlgorithm1(last3_nums):calcAlgorithm2(last3_nums);
        let total = sum(recordDict[curQihao]);
        if(total<10) total='0'+total;
        const res = checkWin(pred,sum(recordDict[curQihao]));
        if(res==='âœ…') winCount++;
        const tr = document.createElement('tr');
        tr.innerHTML=`<td>${curQihao}</td><td>${pred}</td><td>${total}</td><td class="${res==='âœ…'?'correct':'wrong'}">${res}</td>`;
        historyTable.appendChild(tr);
    }

    const winRate = (winCount/testQihaoList.length*100).toFixed(1);
    document.getElementById('winRate').innerText = `å†å²èƒœç‡: ${winRate}%`;
    
    // æœ€æ–°é¢„æµ‹
    const latestThree = sortedQihao.slice(0,3).map(q=>recordDict[q]);
    const nextPred = selectedAlgo==='1'?calcAlgorithm1(latestThree):calcAlgorithm2(latestThree);
    document.getElementById('nextPred').innerText = `æœ€æ–°${latestQihao+1}æœŸé¢„æµ‹: ${nextPred}`;

    // ğŸ”¥æ˜¾ç¤ºé€»è¾‘
    const algoSelect = document.getElementById("algorithmSelect");
    for(let i=0;i<algoSelect.options.length;i++){
        algoSelect.options[i].text = algoSelect.options[i].text.replace(' ğŸ”¥','');
    }
    if(winRate >= 85){
        algoSelect.options[parseInt(selectedAlgo)-1].text += ' ğŸ”¥';
    }
}
</script>
</body>
</html>
